<!DOCTYPE html>
<html>
  <head>
    <title>test</title>
    <meta charset="UTF-8" />
  </head>

  <body>
    <div id="app"></div>
    <h2>test recording</h2>

    <a id="download">Download</a>
    <button id="stop">Stop</button>
    <script>
      let shouldStop = false;
      let stopped = false;
      console.log("shouldStop", shouldStop);
      console.log("stopped", stopped);

      const downloadLink = document.getElementById("download");
      const stopButton = document.getElementById("stop");
      var i = 0;

      stopButton.addEventListener("click", function () {
        shouldStop = true;
        console.log("stop button clicked");
        console.log("shouldStop", shouldStop);
        console.log("stopped", stopped);
      });

      const handleSuccess = function (stream) {
        const options = { mimeType: "audio/webm" };
        const recordedChunks = [];
        const mediaRecorder = new MediaRecorder(stream, options);

        mediaRecorder.addEventListener("dataavailable", function (e) {
          if (e.data.size > 0) {
            console.log(i++, "pushing...");
            recordedChunks.push(e.data);
          }

          if (shouldStop === true && stopped === false) {
            mediaRecorder.stop();
            stopped = true;
          }
        });

        mediaRecorder.addEventListener("stop", function () {
          console.log("stop 1");
          downloadLink.href = URL.createObjectURL(new Blob(recordedChunks));
          downloadLink.download = "acetest.wav";
          console.log("stop 2");
        });
        console.log("before recorder start");
        mediaRecorder.start();
      };

      navigator.mediaDevices
        .getUserMedia({ audio: true, video: false })
        .then(handleSuccess);
    </script>
  </body>
</html>
